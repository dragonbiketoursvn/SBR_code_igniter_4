<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="<?= site_url('css/photo-box.css') ?>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Hairline&family=Bungee+Outline&family=Geo&family=Montserrat+Alternates:wght@100;400;700&family=Nova+Mono&family=Poppins:wght@500&family=Quantico&display=swap" rel="stylesheet">

    <title>Plug n Play photoBox</title>
</head>

<body>

    <div class="photo-box can-send" data-image="unloaded">
        <img class="photo-image" src="">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_front">
            <i class="fas fa-camera"></i>
            <span>License (Back)</span>
        </label>
        <input type="file" class="photo-input" id="pic_front" name="pic_front" accept="image/png, image/jpg">
    </div>

    <div class="photo-box" data-image="unloaded">
        <img class="photo-image" src="">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_rear">
            <i class="fas fa-camera"></i>
            <span>License (Back)</span>
        </label>
        <input type="file" class="photo-input" id="pic_rear" name="pic_rear" accept="image/png, image/jpg">
    </div>

    <div class="photo-box" data-image="unloaded">
        <img class="photo-image" src="http://sbr_code_igniter_4.localhost/Admin/Bikes/displayBikePhoto/1638545317_6ef74614cb24a351a650.jpg">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_front">
            <i class="fas fa-camera"></i>
            <span>License (Front)</span>
        </label>
        <input type="file" class="photo-input" id="pic_front" name="pic_front" accept="image/png, image/jpg">
    </div>

    <div class="photo-box can-send" data-image="unloaded">
        <img class="photo-image" src="http://sbr_code_igniter_4.localhost/Admin/Bikes/displayBikePhoto/1638866160_622415f161e55387dbf2.jpg">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_front">
            <i class="fas fa-camera"></i>
            <span>License (Front)</span>
        </label>
        <input type="file" class="photo-input" id="pic_front" name="pic_front" accept="image/png, image/jpg">
    </div>

    <div class="photo-box can-send" data-image="unloaded">
        <img class="photo-image" src="http://sbr_code_igniter_4.localhost/Admin/Bikes/displayBikePhoto/1638545875_f6429a9ee7e489748748.jpg">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_front">
            <i class="fas fa-camera"></i>
            <span>License (Front)</span>
        </label>
        <input type="file" class="photo-input" id="pic_front" name="pic_front" accept="image/png, image/jpg">
    </div>
    <div class="photo-box can-send" data-image="unloaded">
        <img class="photo-image" src="http://sbr_code_igniter_4.localhost/Admin/Bikes/displayBikePhoto/1641186589_cb8921abe893c35075e7.jpg">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_front">
            <i class="fas fa-camera"></i>
            <span>License (Front)</span>
        </label>
        <input type="file" class="photo-input" id="pic_front" name="pic_front" accept="image/png, image/jpg">
    </div>
    <div class="photo-box can-send" data-image="unloaded">
        <img class="photo-image" src="http://sbr_code_igniter_4.localhost/Admin/Bikes/displayBikePhoto/1638546364_703c725c4b82a011cb74.jpg">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_front">
            <i class="fas fa-camera"></i>
            <span>License (Front)</span>
        </label>
        <input type="file" class="photo-input" id="pic_front" name="pic_front" accept="image/png, image/jpg">
    </div>
    <div class="photo-box can-send" data-image="unloaded">
        <img class="photo-image" src="http://sbr_code_igniter_4.localhost/Admin/Bikes/displayBikePhoto/1638546652_122d846d82f711d54b5b.jpg">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_front">
            <i class="fas fa-camera"></i>
            <span>License (Front)</span>
        </label>
        <input type="file" class="photo-input" id="pic_front" name="pic_front" accept="image/png, image/jpg">
    </div>
    <div class="photo-box can-send" data-image="unloaded">
        <img class="photo-image" src="http://sbr_code_igniter_4.localhost/Admin/Bikes/displayBikePhoto/1638547121_d6973c1656dbc4bc56d5.jpg">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_front">
            <i class="fas fa-camera"></i>
            <span>License (Front)</span>
        </label>
        <input type="file" class="photo-input" id="pic_front" name="pic_front" accept="image/png, image/jpg">
    </div>
    <div class="photo-box can-send" data-image="unloaded">
        <img class="photo-image" src="http://sbr_code_igniter_4.localhost/Admin/Bikes/displayBikePhoto/1638862502_16e8fa1cbbae5a995a93.jpg">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_front">
            <i class="fas fa-camera"></i>
            <span>License (Front)</span>
        </label>
        <input type="file" class="photo-input" id="pic_front" name="pic_front" accept="image/png, image/jpg">
    </div>

    <div class="photo-box new-record" data-image="unloaded">
        <img class="photo-image" src="">
        <div class="delete-button">Delete</div>
        <div class="remove-button">Remove</div>
        <div class="select-button">Select</div>
        <div class="deselect-button">De-select</div>
        <div class="place-holder"><i class="far fa-image"></i></div>
        <label class="select-photo" for="pic_side">
            <i class="fas fa-camera"></i>
            <span>License (Back)</span>
        </label>
        <input type="file" class="photo-input" id="pic_side" name="pic_side" accept="image/png, image/jpg">
    </div>

    <!-- This is the mailForm for sending photos from the page as attachments. In order to work as designed, the view needs 
    to receive $customers from the controller and we have to include the mailForm's js -->

    <div class="mailForm">
        <div class="customerSelect">
            <label for="mailForm-name-input">Select Customer</label>
            <select name="names" id="mailForm-name-input">
                <option value=""></option>
                <?php foreach ($customers as $customer) : ?>
                    <option value="<?= $customer->customer_name ?>"><?= $customer->customer_name ?></option>
                <?php endforeach; ?>
            </select>
        </div>
        <input type="email" class="mailForm-email-input">
        <input type="textarea" class="mailForm-messageBox">
        <div class="mailForm-buttons">
            <button id="mailForm-sendButton">Send</button>
            <button id="mailForm-cancelButton">Cancel</button>
        </div>

    </div>

    <script>
        /* GLOBALS */

        // for photoBoxes
        const photoBoxes = document.querySelectorAll('.photo-box');

        // for edit/updateButtons
        const editButton = document.querySelector('#edit-button');
        const updateButton = document.querySelector('#update-button');

        // for the mailForm
        const mailForms = document.querySelectorAll('.mailForm');
        let selected = [];

        /* || photoBox initialization */
        photoBoxes.forEach(function(el) {

            // Create consts for the components to be shown or hidden initially
            const photoImage = el.querySelector('.photo-image');
            const placeHolder = el.querySelector('.place-holder');
            const selectPhoto = el.querySelector('.select-photo');
            const photoInput = el.querySelector('.photo-input');
            const deleteButton = el.querySelector('.delete-button');
            const removeButton = el.querySelector('.remove-button');
            const selectButton = el.querySelector('.select-button');
            const deselectButton = el.querySelector('.deselect-button');

            // all the buttons and the photoImages are hidden initially
            deleteButton.classList.add('hidden');
            removeButton.classList.add('hidden');
            selectButton.classList.add('hidden');
            deselectButton.classList.add('hidden');
            photoImage.classList.add('hidden');

            // hide the photoInput as well and add event listener to display preview image
            photoInput.classList.add('hidden');
            photoInput.addEventListener('change', function(evt) {

                // Assign file selected by input (via the input's files attribute) to const file
                const file = event.target.files[0];

                // Exit if no file was selected
                if (!file) return;

                // Create a FileReader object 
                const reader = new FileReader();

                // Read file into reader as DataURL
                reader.readAsDataURL(file);

                // Once read operation has successfully finished, set photoImage's src attribute to the value of the reader's 
                // result property (in this case a DataURL)
                // Then unhide photoImage and deletButton and hide selectPhoto
                reader.onload = function(event) {

                    photoImage.src = event.target.result;
                    photoImage.classList.remove('hidden');
                    selectPhoto.classList.add('hidden');

                    // set the photoBox's data-image attribute to 'loaded'
                    el.dataset.image = 'loaded';

                    // Show removeButton if photoBox has new-record class applied, otherwise show deleteButton
                    if (photoImage.parentNode.classList.contains('new-record')) {
                        removeButton.classList.remove('hidden');
                    } else {
                        deleteButton.classList.remove('hidden');
                    }
                }
            });

            // hide everything we don't need for an empty 'new-record' photoBox 
            if (el.classList.contains('new-record')) {
                placeHolder.classList.add('hidden');
                deleteButton.classList.add('hidden');
                removeButton.classList.add('hidden');
                selectButton.classList.add('hidden');
            } else {
                // we won't see selectPhoto unless the edit button is pressed
                selectPhoto.classList.add('hidden');

                // if it's not a 'new-record' we need to check whether a photo has loaded and if so, hide placeholder and show photoImage
                // if 'can-send' class is applied we show the selectButton, otherwise not.
                photoImage.addEventListener('load', function(evt) {
                    // set the photoBox's data-image attribute to 'loaded'
                    el.dataset.image = 'loaded';

                    placeHolder.classList.add('hidden');
                    photoImage.classList.remove('hidden');

                    if (el.classList.contains('can-send') && (el.dataset.editMode !== 'on')) {
                        selectButton.classList.remove('hidden');
                    }
                });
            }

            /* || removeButton */
            // clicking the removeButton removes the preview img and attached file, re-displays selectPhoto, and hides itself
            removeButton.addEventListener('click', function(evt) {
                photoImage.src = '';
                photoInput.value = '';
                selectPhoto.classList.remove('hidden');
                removeButton.classList.add('hidden');
                photoImage.classList.add('hidden');
            })

            /* || selectButton */
            // Clicking selectButton will hide it and show the deselectButton. The selected image will be darkened and
            // the mailForm will display. Finally, the corresponding photo's path will be added to selected[].
            // If selected.length > 4 all selectButtons are hidden
            selectButton.addEventListener('click', function(evt) {
                selectButton.classList.add('hidden');
                deselectButton.classList.remove('hidden');
                mailForms.forEach(mailForm => mailForm.classList.remove('hidden'));

                photoImage.style.filter = 'brightness(50%)';
                const path = photoImage.src;
                const regEx = /(?<=o\/).*/i;
                const result = regEx.exec(path);
                selected.push(result[0]);

                if (selected.length > 4) {
                    // hide all the selectButtons on the page
                    const selectButtons = document.querySelectorAll('.select-button');
                    selectButtons.forEach((button) => button.classList.add('hidden'));
                }
            })

            /* || deselectButton */
            // Clicking deselectButton will hide it and redisplay the selectButton. The selected image will have its normal
            // brightness restored and the corresponding photo's path will be removed from selected[].
            // The mailForm will be hidden if selected.length < 1.
            // If selected.length < 5 any selectButtons whose sibling deselectButtons are hidden will be unhidden
            deselectButton.addEventListener('click', function(evt) {

                const path = photoImage.src;
                const regEx = /(?<=o\/).*/i;
                const result = regEx.exec(path);

                selected = selected.filter(function(element) {
                    return element !== result[0];
                });

                if (selected.length < 1) {
                    mailForms.forEach(mailForm => mailForm.classList.add('hidden'));
                }

                if (selected.length < 5) {
                    // re-display selectButtons only for unselected images in photoBoxes of class 'can-send'
                    const selectButtons = document.querySelectorAll('.select-button');

                    selectButtons.forEach(function(selectButtonElement) {
                        if (selectButtonElement.parentNode.classList.contains('can-send') && selectButtonElement.nextElementSibling.classList.contains('hidden')) {
                            selectButtonElement.classList.remove('hidden');
                        }
                    })
                }

                deselectButton.classList.add('hidden');
                selectButton.classList.remove('hidden');
                photoImage.style.filter = 'brightness(100%)';
            })
        });


        /* Initialize our mailForms*/
        mailForms.forEach(function(mailForm) {

            // Set local constants to grab all the select/deselectButtons on the screen
            const selectButtons = document.querySelectorAll('.select-button');
            const deselectButtons = document.querySelectorAll('.deselect-button');

            // Set local constants for the internal components plus stuff for fetching email addresses as json
            let mailFormEmailAddressesJSON;
            const mailFormGetEmailAddressesURL = "http://sbr_code_igniter_4.localhost/Admin/Customers/emailsAsJSON";
            const mailFormEmailInput = mailForm.querySelector('.mailForm-email-input');
            const mailFormNameInput = mailForm.querySelector('#mailForm-name-input');
            const mailFormMessageBox = mailForm.querySelector('.mailForm-messageBox');
            const mailFormSendButton = mailForm.querySelector('#mailForm-sendButton');
            const mailFormCancelButton = mailForm.querySelector('#mailForm-cancelButton');

            // fetch the email addresses
            fetch(mailFormGetEmailAddressesURL).then((response) => response.json()).then(function(json) {
                mailFormEmailAddressesJSON = json;
            });

            // hide the mailForm and unset all inputs
            mailForm.classList.add('hidden');
            mailFormEmailInput.value = '';
            mailFormNameInput.selectedIndex = 0;
            mailFormMessageBox.value = '';

            mailFormNameInput.addEventListener('change', function(evt) {
                const name = mailFormNameInput.value;
                mailFormEmailInput.value = mailFormEmailAddressesJSON[name] ?? '';
            });

            // give mailFormSendButton a click event listener that will:
            // put the email address, message, and paths of selected photos into a FormData object,
            // send our FormData object as the body of an async POST request to the controller which actually mails everything,
            // and finally return everything to its original state
            mailFormSendButton.addEventListener('click', function(evt) {

                const formData = new FormData();
                formData.append('address', mailFormEmailInput.value);

                // Add a default message if the messageBox is empty
                formData.append('message', ((mailFormMessageBox.value == '') ? 'Thanks for choosing Saigon Bike Rentals!' : mailFormMessageBox.value));

                for (let index = 0; index < selected.length; index++) {
                    formData.append(('path' + (index + 1)), selected[index]);
                }

                if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(mailFormEmailInput.value)) {
                    fetch("http://sbr_code_igniter_4.localhost/Admin/Photos/mailPhotos", {
                        method: 'POST',
                        body: formData
                    }).then(response => response.text().then(text => alert(text)).catch(error => console.log(error)));

                    selected = [];
                    selectButtons.forEach(el => el.classList.remove('hidden'));
                    deselectButtons.forEach(el => el.classList.add('hidden'));
                    mailFormEmailInput.value = '';
                    mailFormMessageBox.value = '';
                    mailFormNameInput.selectedIndex = 0;
                    mailForm.classList.add('hidden');
                    photoImages.forEach(el => el.style.filter = 'brightness(100%)');
                } else {
                    alert('Please enter a valid email address');
                }
            });

            // And lastly our mailFormCancelButton will do everything the sendButton does except the send part
            mailFormCancelButton.addEventListener('click', function(evt) {
                selected = [];
                selectButtons.forEach(function(el) {
                    if ((el.parentNode.dataset.image === 'loaded') && (el.parentNode.classList.contains('can-send'))) {
                        el.classList.remove('hidden')
                    }
                });

                deselectButtons.forEach(e => e.classList.add('hidden'));
                mailFormEmailInput.value = '';
                mailFormMessageBox.value = '';
                mailFormNameInput.selectedIndex = 0;
                mailForm.classList.add('hidden');

                // grab all the photoImage elements on the page and switch back to normal brightness
                const photoImages = document.querySelectorAll('.photo-image');
                photoImages.forEach(el => el.style.filter = 'brightness(100%)');
            });
        });

        editButton.addEventListener('click', function(evt) {
            if (selected.length > 0) {
                alert('Cancel the mail form first');
            } else {
                photoBoxes.forEach(function(el) {
                    if (!el.classList.contains('new-record')) {

                        // set a data-attribute to show we're now in edit mode
                        el.dataset.editMode = 'on';

                        // Create consts for the components to be shown or hidden initially
                        const selectPhoto = el.querySelector('.select-photo');
                        const photoImage = el.querySelector('.photo-image');
                        const deleteButton = el.querySelector('.delete-button');
                        const placeHolder = el.querySelector('.place-holder');
                        // const photoInput = el.querySelector('.photo-input');
                        // const removeButton = el.querySelector('.remove-button');
                        const selectButton = el.querySelector('.select-button');
                        // const deselectButton = el.querySelector('.deselect-button');

                        selectButton.classList.add('hidden');

                        if (selected.length > 0) {
                            alert('penis');
                        }

                        if (el.dataset.image !== 'loaded') {
                            placeHolder.classList.add('hidden');
                            selectPhoto.classList.remove('hidden');
                        } else {
                            deleteButton.classList.remove('hidden');
                        }
                    }
                });
            }
        })
    </script>
</body>

</html>